import json
from pathlib import Path
from playwright.sync_api import sync_playwright

LOCAL_FILE = Path("2025lotto_numbers_1_to_1182_final.json")

def fetch_lotto_from_web():
    with sync_playwright() as p:
        # ê°€ìƒ ë¸Œë¼ìš°ì € ì‹¤í–‰
        browser = p.chromium.launch(headless=True)
        page = browser.new_page()
        
        # ë™í–‰ë³µê¶Œ ë©”ì¸ í˜ì´ì§€ ì ‘ì†
        print("ğŸŒ ë™í–‰ë³µê¶Œ í™ˆí˜ì´ì§€ ì ‘ì† ì¤‘...")
        page.goto("https://www.dhlottery.co.kr/common.do?method=main", timeout=60000)
        
        # í™”ë©´ì—ì„œ ë²ˆí˜¸ ì¶”ì¶œ (CSS ì„ íƒì í™œìš©)
        try:
            draw_no = int(page.locator("#lottoDrwNo").inner_text())
            num1 = int(page.locator("#drwtNo1").inner_text())
            num2 = int(page.locator("#drwtNo2").inner_text())
            num3 = int(page.locator("#drwtNo3").inner_text())
            num4 = int(page.locator("#drwtNo4").inner_text())
            num5 = int(page.locator("#drwtNo5").inner_text())
            num6 = int(page.locator("#drwtNo6").inner_text())
            bonus = int(page.locator("#bnusNo").inner_text())
            
            browser.close()
            return {
                "draw_no": draw_no,
                "numbers": [num1, num2, num3, num4, num5, num6],
                "bonus": bonus
            }
        except Exception as e:
            print(f"âŒ í™”ë©´ ìš”ì†Œ ì½ê¸° ì‹¤íŒ¨: {e}")
            browser.close()
            return None

def main():
    if not LOCAL_FILE.exists():
        print("âŒ ë¡œì»¬ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    # ì›¹ì—ì„œ ì‹¤ì œ í™”ë©´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    new_data = fetch_lotto_from_web()
    if not new_data:
        return

    with open(LOCAL_FILE, "r", encoding="utf-8") as f:
        local_data = json.load(f)

    local_latest = local_data[0]["draw_no"]
    print(f"ğŸ“Œ í˜„ì¬ ë¡œì»¬: {local_latest}íšŒ / í™”ë©´ í™•ì¸ ê²°ê³¼: {new_data['draw_no']}íšŒ")

    if new_data["draw_no"] > local_latest:
        local_data.insert(0, new_data)
        with open(LOCAL_FILE, "w", encoding="utf-8") as f:
            json.dump(local_data, f, ensure_ascii=False, indent=2)
        print(f"ğŸ‰ {new_data['draw_no']}íšŒì°¨ ì—…ë°ì´íŠ¸ ì™„ë£Œ!")
    else:
        print("âœ… ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤.")

if __name__ == "__main__":
    main()
