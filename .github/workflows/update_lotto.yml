import json
import requests
import time
from pathlib import Path

# ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
ALL_JSON_URL = f"https://smok95.github.io/lotto/results/all.json?t={int(time.time())}"
LOCAL_FILE = Path("2025lotto_numbers_1_to_1182_final.json")

def main():
    if not LOCAL_FILE.exists():
        print(f"âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {LOCAL_FILE}")
        return

    # ë³´ì•ˆ ì°¨ë‹¨ ë°©ì§€ë¥¼ ìœ„í•œ ë¸Œë¼ìš°ì € í—¤ë”
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Cache-Control': 'no-cache'
    }

    try:
        print(f"ğŸŒ ë°ì´í„° í˜¸ì¶œ ì¤‘: {ALL_JSON_URL}")
        res = requests.get(ALL_JSON_URL, headers=headers, timeout=20)
        res.raise_for_status()
        
        # JSON ë°ì´í„°ì¸ì§€ ê²€ì¦
        all_data = res.json()
        if not isinstance(all_data, list):
            print("âŒ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (ë°°ì—´ ì•„ë‹˜)")
            return
            
    except Exception as e:
        print(f"âŒ API í˜¸ì¶œ ì‹¤íŒ¨: {e}")
        return

    with open(LOCAL_FILE, "r", encoding="utf-8") as f:
        local_data = json.load(f)

    local_latest = local_data[0]["draw_no"]
    latest_item = all_data[-1]
    latest_draw = latest_item["draw_no"]

    print(f"ğŸ“Œ í˜„ì¬ ìƒíƒœ - ë¡œì»¬: {local_latest}íšŒ / ì›ë³¸: {latest_draw}íšŒ")

    if latest_draw > local_latest:
        new_entry = {
            "draw_no": latest_draw,
            "numbers": latest_item["numbers"],
            "bonus": latest_item["bonus_no"]
        }
        local_data.insert(0, new_entry)
        
        with open(LOCAL_FILE, "w", encoding="utf-8") as f:
            json.dump(local_data, f, ensure_ascii=False, indent=2)
        print(f"ğŸ‰ {latest_draw}íšŒì°¨ ì—…ë°ì´íŠ¸ ì„±ê³µ!")
    else:
        print("âœ… ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤.")

if __name__ == "__main__":
    main()
