import json
import requests
import time
from pathlib import Path

# ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ ì¶”ê°€
ALL_JSON_URL = f"https://smok95.github.io/lotto/results/all.json?nocache={int(time.time())}"
LOCAL_FILE = Path("2025lotto_numbers_1_to_1182_final.json")

def main():
    # 1. ë¡œì»¬ íŒŒì¼ í™•ì¸
    if not LOCAL_FILE.exists():
        print(f"âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {LOCAL_FILE}")
        return

    with open(LOCAL_FILE, "r", encoding="utf-8") as f:
        local_data = json.load(f)
    
    local_latest = local_data[0]["draw_no"]
    print(f"ğŸ“Œ ë¡œì»¬ í˜„ì¬ ìµœì‹ : {local_latest}íšŒ")

    # 2. GitHub ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í—¤ë” ì¶”ê°€ë¡œ ì°¨ë‹¨ ë°©ì§€)
    headers = {'User-Agent': 'Mozilla/5.0'}
    try:
        res = requests.get(ALL_JSON_URL, headers=headers, timeout=20)
        res.raise_for_status()
        
        # í…ìŠ¤íŠ¸ ì‘ë‹µ í™•ì¸ (JSONì¸ì§€ í™•ì¸)
        content = res.text.strip()
        if not content.startswith('['):
            print("âŒ ë°›ì€ ë°ì´í„°ê°€ JSON ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.")
            return
            
        all_data = res.json()
    except Exception as e:
        print(f"âŒ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: {e}")
        return

    # 3. ìµœì‹  íšŒì°¨ ë¹„êµ ë° ì—…ë°ì´íŠ¸
    # ë¦¬ìŠ¤íŠ¸ì˜ ë§ˆì§€ë§‰ ìš”ì†Œê°€ 1207íšŒì¸ì§€ í™•ì¸
    latest = all_data[-1]
    latest_draw = latest["draw_no"]
    print(f"ğŸŒ GitHub ìƒì˜ ìµœì‹ : {latest_draw}íšŒ")

    if latest_draw <= local_latest:
        print("âœ… ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤.")
        return

    # 4. ìƒˆ ë°ì´í„° ì‚½ì… (êµ¬ì¡° ë§ì¶¤: bonus_no -> bonus)
    new_entry = {
        "draw_no": latest_draw,
        "numbers": latest["numbers"],
        "bonus": latest["bonus_no"] # ë°›ì•„ì˜¨ ë°ì´í„°ì˜ í‚¤ ì´ë¦„ì— ë§ì¶¤
    }

    local_data.insert(0, new_entry)

    # 5. ì €ì¥
    with open(LOCAL_FILE, "w", encoding="utf-8") as f:
        json.dump(local_data, f, ensure_ascii=False, indent=2)

    print(f"ğŸ‰ {latest_draw}íšŒì°¨ ì—…ë°ì´íŠ¸ ì™„ë£Œ!")

if __name__ == "__main__":
    main()
